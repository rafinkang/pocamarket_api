# ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: Deploy pocamarket-api to EC2

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´: 'master' ë¸Œëœì¹˜ ëŒ€ìƒ PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ.
on:
  push:
    branches: [ "master" ]

# ì›Œí¬í”Œë¡œìš° ë‚´ì—ì„œ ì‚¬ìš©í•  í™˜ê²½ ë³€ìˆ˜ ì •ì˜
env:
  IMAGE_NAME: pocamarket-api # EC2ì—ì„œ ì‹¤í–‰ë  ì»¨í…Œì´ë„ˆ ì´ë¦„
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/pocamarket-api

jobs:
  build-and-deploy:
    # ì‹¤í–‰ í™˜ê²½
    runs-on: ubuntu-latest
    steps:
      # 1. GitHub ì €ì¥ì†Œì˜ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Docker ë¹Œë“œ í™˜ê²½ ìµœì í™” ì„¤ì • (Buildx)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. Docker Hub ë¡œê·¸ì¸ (GitHub Secrets ì‚¬ìš©)
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Docker Hubì— í‘¸ì‹œ
      #    - latest: í•­ìƒ ìµœì‹  ë²„ì „ì„ ê°€ë¦¬í‚¤ëŠ” íƒœê·¸
      #    - ${github.sha}: ê° ì»¤ë°‹ë³„ ê³ ìœ  ë²„ì „ì„ ê°€ë¦¬í‚¤ëŠ” íƒœê·¸
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 5. EC2ì— SSHë¡œ ì ‘ì†í•˜ì—¬ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Deploy API to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # EC2 ì„œë²„ì—ì„œ ì‹¤í–‰ë  ìŠ¤í¬ë¦½íŠ¸
            # pocamarket_api/.env íŒŒì¼ ìƒì„±
            cd /var/www/pocamarket/pocamarket_api

            # .env íŒŒì¼ ì‚­ì œ
            rm -f .env

            # .env íŒŒì¼ ìƒì„±
            echo "DB_URL=${{ secrets.DB_URL }}" >> .env
            echo "DB_PORT=${{ secrets.DB_PORT }}" >> .env
            echo "DB=${{ secrets.DB }}" >> .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}" >> .env
            echo "JWT_ACCESS_TOKEN_VALIDITY_MS=${{ secrets.JWT_ACCESS_TOKEN_VALIDITY_MS }}" >> .env
            echo "JWT_REFRESH_TOKEN_VALIDITY_MS=${{ secrets.JWT_REFRESH_TOKEN_VALIDITY_MS }}" >> .env
            echo "SPRING_PROFILES_ACTIVE=${{ secrets.SPRING_PROFILES_ACTIVE }}" >> .env
            echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}" >> .env
            echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}" >> .env
            echo "NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}" >> .env
            echo "NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}" >> .env

            # docker-compose.ymlì´ ìˆëŠ” í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd /var/www/pocamarket/ 
            
            # Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ pull
            docker pull ${{ env.DOCKER_IMAGE }}:latest

            # Docker Composeë¡œ 'pocamarket-api' ì„œë¹„ìŠ¤ë§Œ ì¬ì‹œì‘
            docker-compose up -d --no-deps pocamarket-api
            
            # ëª¨ë“  ë„ì»¤ ì´ë¯¸ì§€, ì»¨í…Œì´ë„ˆ, ë„¤íŠ¸ì›Œí¬, ë¹Œë“œìºì‹œ ì •ë¦¬
            docker system prune -af

      # 6. Docker Hub ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ (Docker Hub API ì‚¬ìš©)
      - name: Clean up old Docker Hub images
        run: |
          set -e  # ì—ëŸ¬ ë°œìƒì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
          
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          REPO_NAME="${{ env.IMAGE_NAME }}"
          USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
          PASSWORD="${{ secrets.DOCKERHUB_TOKEN }}"
          KEEP_COUNT=5  # ìœ ì§€í•  ì´ë¯¸ì§€ ê°œìˆ˜
          
          echo "Docker Hub ì´ë¯¸ì§€ ì •ë¦¬ ì‹œì‘: ${USERNAME}/${REPO_NAME}"
          
          # Docker Hub API ì¸ì¦ì„ ìœ„í•œ í† í° íšë“
          echo "Docker Hub ì¸ì¦ ì¤‘..."
          TOKEN=$(curl -s -H "Content-Type: application/json" -X POST \
            -d '{"username": "'${USERNAME}'", "password": "'${PASSWORD}'"}' \
            https://hub.docker.com/v2/users/login/ | jq -r .token)
          
          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "âŒ Docker Hub ì¸ì¦ ì‹¤íŒ¨"
            exit 1
          fi
          
          echo "âœ… Docker Hub ì¸ì¦ ì„±ê³µ"
          
          # ëª¨ë“  íƒœê·¸ ì¡°íšŒ (ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬, latest ì œì™¸)
          echo "íƒœê·¸ ëª©ë¡ ì¡°íšŒ ì¤‘..."
          TAGS_JSON=$(curl -s -H "Authorization: JWT ${TOKEN}" \
            "https://hub.docker.com/v2/repositories/${USERNAME}/${REPO_NAME}/tags/?page_size=100")
          
          # ì‚­ì œí•  íƒœê·¸ ê²°ì • (latest ì œì™¸í•˜ê³  ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì˜¤ë˜ëœ ê²ƒë“¤ë§Œ ì„ íƒ)
          ALL_TAGS_COUNT=$(echo "$TAGS_JSON" | jq -r ".results[] | select(.name != \"latest\") | .name" | wc -l)
          
          if [ "$ALL_TAGS_COUNT" -le "$KEEP_COUNT" ]; then
            echo "ğŸ” í˜„ì¬ íƒœê·¸ ìˆ˜($ALL_TAGS_COUNT)ê°€ ìœ ì§€í•  ê°œìˆ˜($KEEP_COUNT) ì´í•˜ì…ë‹ˆë‹¤."
            TAGS_TO_DELETE=""
          else
            DELETE_COUNT=$((ALL_TAGS_COUNT - KEEP_COUNT))
            echo "ğŸ“Š ì „ì²´ íƒœê·¸ ìˆ˜: $ALL_TAGS_COUNT, ì‚­ì œí•  íƒœê·¸ ìˆ˜: $DELETE_COUNT"
            
            # ì˜¤ë˜ëœ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì‚­ì œí•  íƒœê·¸ë“¤ ì„ íƒ
            TAGS_TO_DELETE=$(echo "$TAGS_JSON" | \
              jq -r ".results[] | select(.name != \"latest\") | [.last_updated, .name] | @csv" | \
              sort | head -n "$DELETE_COUNT" | cut -d',' -f2 | tr -d '"')
          fi
          
          if [ -z "$TAGS_TO_DELETE" ]; then
            echo "ğŸ” ì‚­ì œí•  íƒœê·¸ê°€ ì—†ìŠµë‹ˆë‹¤."
          else
            echo "ğŸ“‹ ì‚­ì œí•  íƒœê·¸ ëª©ë¡:"
            echo "$TAGS_TO_DELETE"
            
            # íƒœê·¸ë“¤ ì‚­ì œ
            echo "$TAGS_TO_DELETE" | while read -r tag; do
              if [ ! -z "$tag" ] && [ "$tag" != "latest" ]; then
                echo "ğŸ—‘ï¸  ì‚­ì œ ì¤‘: $tag"
                
                DELETE_RESPONSE=$(curl -s -w "%{http_code}" -o /dev/null \
                  -X DELETE -H "Authorization: JWT ${TOKEN}" \
                  "https://hub.docker.com/v2/repositories/${USERNAME}/${REPO_NAME}/tags/${tag}/")
                
                if [ "$DELETE_RESPONSE" = "204" ]; then
                  echo "   âœ… $tag ì‚­ì œ ì„±ê³µ"
                else
                  echo "   âŒ $tag ì‚­ì œ ì‹¤íŒ¨ (HTTP: $DELETE_RESPONSE)"
                fi
                
                # API í˜¸ì¶œ ì œí•œì„ ìœ„í•œ ëŒ€ê¸°
                sleep 2
              fi
            done
          fi
          
          echo "ğŸ‰ Docker Hub ì´ë¯¸ì§€ ì •ë¦¬ ì™„ë£Œ"